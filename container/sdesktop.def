Bootstrap: docker
From: rockylinux:9

%labels
	Author z3545907@ad.unsw.edu.au
	Version 1.0
	Description XFCE4 Container based on Rocky 9 
%files
	./desktop.cpu.sh /opt/sdesktop/desktop.cpu.sh
	./ucsf-chimerax-1.10.1-1.el9.x86_64.rpm
	./xfce4-session-logout.sh
%post
	cat > /etc/yum.repos.d/cuda-rhel9.repo << EOF
[cuda-rhel9-x86_64]
name=cuda-rhel9-x86_64
baseurl=https://developer.download.nvidia.com/compute/cuda/repos/rhel9/x86_64
enabled=1
gpgcheck=1
gpgkey=https://developer.download.nvidia.com/compute/cuda/repos/rhel9/x86_64/D42D0685.pub
EOF
	dnf update -y
	
	dnf install -y epel-release
	dnf update -y

	groupadd -g 2015 munge
	useradd -u 2015 -g 2015 -r -d /var/lib/munge -s /sbin/nologin munge

	groupadd -g 2016 slurm
	useradd -u 2016 -g 2016 -r -d /var/lib/slurm -s /sbin/nologin slurm

	dnf install -y \
		xorg-x11-server-utils \
		xorg-x11-xauth \
		xorg-x11-server-Xvfb \
		mesa-libGL \
		mesa-libGLU \
		mesa-libGL-devel \
		mesa-dri-drivers \
		libglvnd-glx \
		libglvnd-opengl \
		libglvnd-devel

	dnf install -y \
		expect \
		tcl-devel \
		tcsh \
		jq

	dnf install -y \
		tigervnc-server \
		tigervnc-server-module \
		xorg-x11-fonts-Type1 \
		xorg-x11-fonts-misc \
		dejavu-sans-fonts \
		dejavu-sans-mono-fonts
	
	dnf install -y procps \
		sssd
	
	dnf groupinstall -y "Xfce"

	dnf install -y \
		firefox \
		thunar \
		xfce4-terminal \
		xfce4-panel \
		xfce4-session \
		xfce4-settings \
		xfce4-appfinder \
		xfwm4 \
		xfdesktop \
		mousepad \
		ristretto \
		python3 \
		python3-pip \
		vim \
		nano \
		ripgrep \
		numpy \
		zsh

	dnf config-manager --set-enabled crb
	dnf install -y compat-openssl11-1:1.1.1k-5.el9_6.1.x86_64
	dnf install -y xcb-util-cursor*
	dnf install -y libffi3.1-3.1-36.el9.x86_64
	dnf install -y ./ucsf-chimerax-1.10.1-1.el9.x86_64.rpm

	dnf groupinstall -y "Development Tools"
	dnf install -y \
		mesa-vulkan-drivers \
		vulkan-tools \
		glx-utils
		#xorg-x11-nvidia-3:580.95.05-1.el9 \
		#nvidia-xconfig-3:580.95.05-1.el9 \
		#nvidia-settings-3:580.95.05-1.el9

	dnf install -y \
		slurm \
		munge \
		munge-libs 
	
	dnf install -y \
		firefox \
		mousepad \
		wget \
		difftastic \
		btop \
		procs \
		ripgrep \
		fd-find	\
		libreoffice \
		ccze

	dnf install -y https://github.com/VirtualGL/virtualgl/releases/download/3.1.3/VirtualGL-3.1.3.x86_64.rpm

	dnf clean all

	mkdir -p /tmp/nonvc && mkdir -p /opt/novnc && wget -P /tmp/novnc https://github.com/novnc/noVNC/archive/refs/tags/v1.6.0.tar.gz && tar xvf /tmp/novnc/v1.6.0.tar.gz -C /opt/novnc && rm -rf /tmp/novnc && opt/novnc/noVNC-1.6.0/utils/novnc_proxy --idle-timeout 1
	mv /usr/bin/xfce4-session-logout /usr/bin/xfce4-session-logout.real
	mv ./xfce4-session-logout.sh /usr/bin/xfce4-session-logout
	#dnf remove -y polkit
